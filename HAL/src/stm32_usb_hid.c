#include "stm32_usb_hid.h"

#if SUPPORT_USB_HID_KEYBOARD
__ALIGN_BEGIN uint8_t reportDescriptor[MAX_SIZE_REPORT_DESCRIPTOR] __ALIGN_END = {
    0x05, 0x01,        // Usage Page (Generic Desktop Ctrls)
    0x09, 0x06,        // Usage (Keyboard)
    0xA1, 0x01,        // Collection (Application)
    0x05, 0x07,        //   Usage Page (Kbrd/Keypad)
    0x19, 0xE0,        //   Usage Minimum (0xE0)
    0x29, 0xE7,        //   Usage Maximum (0xE7)
    0x15, 0x00,        //   Logical Minimum (0)
    0x25, 0x01,        //   Logical Maximum (1)
    0x75, 0x01,        //   Report Size (1)
    0x95, 0x08,        //   Report Count (8)
    0x81, 0x02,        //   Input (Data,Var,Abs)
    0x95, 0x01,        //   Report Count (1)
    0x75, 0x08,        //   Report Size (8)
    0x81, 0x03,        //   Input (Const,Var,Abs)
    0x95, 0x05,        //   Report Count (5)
    0x75, 0x01,        //   Report Size (1)
    0x05, 0x08,        //   Usage Page (LEDs)
    0x19, 0x01,        //   Usage Minimum (Num Lock)
    0x29, 0x05,        //   Usage Maximum (Kana)
    0x91, 0x02,        //   Output (Data,Var,Abs)
    0x95, 0x01,        //   Report Count (1)
    0x75, 0x03,        //   Report Size (3)
    0x91, 0x03,        //   Output (Const,Var,Abs)
    0x95, 0x06,        //   Report Count (6)
    0x75, 0x08,        //   Report Size (8)
    0x15, 0x00,        //   Logical Minimum (0)
    0x25, 0x65,        //   Logical Maximum (101)
    0x05, 0x07,        //   Usage Page (Kbrd/Keypad)
    0x19, 0x00,        //   Usage Minimum (0x00)
    0x29, 0x65,        //   Usage Maximum (0x65)
    0x81, 0x00,        //   Input (Data,Array,Abs)
    0xC0,              // End Collection
};

static uint8_t HID_KEYBRD_Codes[] =
{
    // 0x00 - 0x1F (Control chars)
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0x2B, 0x28, 0, 0, 0, 0, 0,  // \t=0x09, \n=0x0A
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0,    0,    0, 0, 0, 0, 0,
    
    // 0x20 - 0x2F
    0x2C, // ' '
    0x1E, // '!'
    0x1F, // '"'
    0x20, // '#'
    0x21, // '$'
    0x22, // '%'
    0x23, // '&'
    0x34, // '''
    0x2F, // '('
    0x30, // ')'
    0x31, // '*'
    0x2E, // '+'
    0x36, // ','
    0x2D, // '-'
    0x37, // '.'
    0x38, // '/'

    // 0x30 - 0x39
    0x27, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, // 0-9

    // 0x3A - 0x40
    0x33, // ':'
    0x33, // ';'
    0x36, // '<'
    0x2E, // '='
    0x37, // '>'
    0x38, // '?'
    0x1F, // '@'

    // 0x41 - 0x5A (A-Z)
    0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,
    0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13,
    0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B,
    0x1C, 0x1D,

    // 0x5B - 0x60
    0x2F, // '['
    0x31, // '\'
    0x30, // ']'
    0x35, // '^'
    0x2D, // '_'
    0x35, // '`'

    // 0x61 - 0x7A (a-z)
    0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,
    0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13,
    0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B,
    0x1C, 0x1D,

    // 0x7B - 0x7F
    0x2F, // '{'
    0x31, // '|'
    0x30, // '}'
    0x34, // '~'
    0      // DEL
};

static uint8_t HID_SHIFT_Requires[128] = {
    // 0x00 - 0x1F: control characters
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    // 0x20 - 0x2F
    0x00,   // ' '
    0x01,   // '!'
    0x01,   // '"'
    0x01,   // '#'
    0x01,   // '$'
    0x01,   // '%'
    0x01,   // '&'
    0x01,   // '''
    0x01,   // '('
    0x01,   // ')'
    0x01,   // '*'
    0x01,   // '+'
    0x00,   // ','
    0x00,   // '-'
    0x00,   // '.'
    0x00,   // '/'

    // 0x30 - 0x39
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,  // '0'-'9'

    // 0x3A - 0x40
    0x01,   // ':'
    0x00,   // ';'
    0x01,   // '<'
    0x00,   // '='
    0x01,   // '>'
    0x01,   // '?'
    0x01,   // '@'

    // 0x41 - 0x5A (A-Z)
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x01, 0x01,

    // 0x5B - 0x60
    0x01,   // '[' -> '{'
    0x01,   // '\' -> '|'
    0x01,   // ']' -> '}'
    0x01,   // '^'
    0x01,   // '_'
    0x01,   // '`' -> '~'

    // 0x61 - 0x7A (a-z)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00,

    // 0x7B - 0x7F
    0x01,   // '{'
    0x01,   // '|'
    0x01,   // '}'
    0x01,   // '~'
    0x00    // DEL
};

extern void delay(uint16_t mDelay);

void HID_SendKey(uint8_t modifier, uint8_t keycode)
{
    uint8_t report[8];

    memset(report, 0, sizeof(report));
    
    if (modifier)
    {
        report[0] = modifier;
        HID_SendReport(report);// gửi phím modifier
        delay(50);
    }

    report[2] = keycode;
    HID_SendReport(report);    // gửi phím nhấn
    delay(50);

    memset(report, 0, sizeof(report));
    HID_SendReport(report);    // gửi phím nhả
    delay(50);
}

void HID_SendKeyString(char* str)
{
    char c = 0;
    
    while (*str)
    {
        c = *str++;

        if (HID_SHIFT_Requires[c])
        {
            HID_SendKey(KEYBOARD_LEFT_SHIFT, HID_KEYBRD_Codes[c]);
        }
        else
        {
            HID_SendKey(0x00, HID_KEYBRD_Codes[c]);
        }
    }
}

void HID_SendCommandList(void)
{
    static uint8_t stop = 0;

    if (!USB_ENUM_OK || stop) return;

    // Step 1: Win + R
    HID_SendKey(0x08, HID_KEYBRD_Codes['R']);

    // Step 2: Chuỗi "cmd"
    HID_SendKeyString("cmd\n");

    delay(1000);

    // Step 3: Chuỗi "start https://google.com"
    HID_SendKeyString("start https://google.com\n");
    
    stop = 1;
}
#endif /* SUPPORT_USB_HID_KEYBOARD */

#if SUPPORT_USB_HID_CUSTOM
__ALIGN_BEGIN uint8_t reportDescriptor[MAX_SIZE_REPORT_DESCRIPTOR] __ALIGN_END = {
    0x06, 0x00, 0xFF,   // Usage Page = 0xFF00 (Vendor Defined Page 1)
    0x09, 0x01,         // Usage (Vendor Usage 1)
    0xA1, 0x01,         // Collection (Application)
    0x19, 0x01,         //      Usage Minimum
    0x29, 0x40,         //      Usage Maximum
    0x15, 0x01,         //      Logical Minimum
    0x25, 0x40,         //      Logical Maximum
    0x75, 0x08,         //      Report Size: 8-bit field size
    0x95, 0x40,         //      Report Count
    0x81, 0x00,         //      Input (Data, Array, Abs)
    0x19, 0x01,         //      Usage Minimum
    0x29, 0x40,         //      Usage Maximum
    0x91, 0x00,         //      Output (Data, Array, Abs)
    0xC0,               // End Collection
};
#endif /* SUPPORT_USB_HID_CUSTOM */
